<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fil d'actualit√© - ISEP Connect</title>
    <link rel="stylesheet" th:href="@{/css/charteGraphique.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/feed.css}">
    <script src="https://unpkg.com/lucide@latest"></script>
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta th:if="${session.userId != null}" name="userId" th:content="${session.userId}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/fr.min.js"></script>
</head>
<body class="bg-dark">

<div th:replace="~{fragments/header :: header-fragment}"></div>

<div class="container blog-layout">

    <aside class="sidebar-left">
        <div class="user-profile-card card">
            <div class="profile-header">
                <img th:src="@{${userAvatar}}" alt="Avatar" class="avatar-large">
                <div class="profile-info">
                    <h4 th:text="${name}">Utilisateur</h4>
                    <span>Cycle Ing√©nieur ‚Ä¢ ISEP</span>
                </div>
            </div>
            <div class="visibility-filters card-sub-section">
                <p class="section-label">Affichage</p>
                <div class="filter-group">
                    <label><input id="publicCheckbox" type="checkbox" checked> <span class="dot public"></span> PUBLIC</label>
                    <label><input id="friendsCheckbox" type="checkbox" checked> <span class="dot friends"></span> FRIENDS</label>
                    <label><input id="privateCheckbox" type="checkbox" checked> <span class="dot private"></span> PRIVATE</label>
                </div>
            </div>
        </div>

        <nav class="side-nav card">
            <a href="#" class="nav-item active"><i data-lucide="home"></i> Fil d'actualit√©</a>
            <a href="#" class="nav-item"><i data-lucide="users"></i> Mes Groupes</a>
            <a href="#" class="nav-item"><i data-lucide="message-square"></i> Messages</a>
            <a href="#" class="nav-item"><i data-lucide="calendar"></i> Calendrier</a>
            <hr>
            <a href="#" class="nav-item"><i data-lucide="settings"></i> Param√®tres</a>
        </nav>
    </aside>

    <main class="feed-main">
        <div th:if="${session.userId != null}" class="publish-card card">
            <form th:action="@{/post}" method="post" enctype="multipart/form-data">
                <div class="publish-top">
                    <img th:src="@{${userAvatar}}" class="avatar-small">
                    <div class="publish-input-area">
                        <textarea name="content" placeholder="Quoi de neuf ?" required></textarea>
                    </div>
                </div>

                <div class="publish-bottom">
                    <div class="media-inputs">
                        <button id="postVideo" type="button" class="btn-icon-upload" title="Image">
                            <i data-lucide="image"></i>
                        </button>
                        <button id="postImage" type="button" class="btn-icon-upload" onclick="document.getElementById('postVideoUrl').click()" title="Vid√©o">
                            <i data-lucide="video"></i>
                        </button>

                        <input type="file" id="postImageUrl" name="postImageUrl" accept="image/*" style="display: none;">
                        <input type="file" id="postVideoUrl" name="postVideoUrl" accept=".mp4, .avi" style="display: none;">

                        <div class="vertical-divider"></div>

                        <div class="publish-options">
                            <select name="visibilityType" class="custom-select">
                                <option value="PUBLIC">Public</option>
                                <option value="FRIENDS">Amis</option>
                                <option value="PRIVATE">Priv√©</option>
                            </select>
                            <label class="checkbox-label">
                                <input type="checkbox" name="allowComments" value="true" checked />
                                <span>Commentaires</span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Publier</button>
                </div>
            </form>
        </div>

        <div class="posts-list">
            <article th:each="post : ${posts}"
                     class="post-card card"
                     th:attr="data-post-card-id=${post.id}, data-post-visibility=${post.visibilityType}">

                <div class="post-header">
                    <img th:src="@{${post.author.profilePictureUrl}}" class="avatar-small">
                    <div class="post-meta">
                        <strong th:text="${post.author.username}">Auteur</strong>
                        <div class="post-sub-meta">
                            <span class="post-date" th:attr="data-timestamp=${post.createdAt}"></span>
                            <span class="vis-badge" th:text="${post.visibilityType}"></span>
                        </div>
                    </div>

                    <div class="post-actions" th:if="${isConnect != null and isConnect.toString() == post.author.id.toString()}">
                        <button type="button" class="btn-icon" th:attr="data-post-id=${post.id}" onclick="openEditModalFromButton(this)">
                            <i data-lucide="edit-2"></i>
                        </button>
                        <button type="button" class="btn-icon btn-delete" th:attr="data-post-id=${post.id}">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </div>

                <div class="post-content">
                    <p th:text="${post.content}">Contenu...</p>

                    <div class="post-media-container" th:if="${not #lists.isEmpty(post.medias)}">
                        <div th:each="pm : ${post.medias}" class="media-item">
                            <img th:if="${pm.mediaType.toString().equals('IMAGE')}"
                                 th:src="@{${pm.fileUrl}}" class="img-fluid rounded">

                            <video th:if="${pm.mediaType.toString().equals('VIDEO')}" controls class="video-fluid rounded">
                                <source th:src="@{${pm.fileUrl}}" type="video/mp4">
                            </video>
                        </div>
                    </div>
                </div>

                <div class="post-footer">
                    <div class="reactions-bar" th:attr="data-post-id=${post.id}">
                        <button class="reaction-btn" data-type="LIKE"><span class="emoji">üëç</span><span class="count">0</span></button>
                        <button class="reaction-btn" data-type="LOVE"><span class="emoji">‚ù§Ô∏è</span><span class="count">0</span></button>
                        <button class="reaction-btn" data-type="HAHA"><span class="emoji">üòÇ</span><span class="count">0</span></button>
                        <button class="reaction-btn" data-type="WOW"><span class="emoji">üòÆ</span><span class="count">0</span></button>
                        <button class="reaction-btn" data-type="SAD"><span class="emoji">üò¢</span><span class="count">0</span></button>
                        <button class="reaction-btn" data-type="ANGRY"><span class="emoji">üò†</span><span class="count">0</span></button>
                        <span class="reaction-total">0 r√©actions</span>
                    </div>
                    <button class="action-btn btn-toggle-comments" th:if="${post.allowComments}" th:attr="data-post-id=${post.id}"><i data-lucide="message-circle"></i> <span class="comment-count">0</span></button>
                    <button class="action-btn btn-share"><i data-lucide="share-2"></i></button>
                </div>

                <div class="comments-section" th:if="${post.allowComments}" th:attr="data-post-id=${post.id}" style="display:none;">
                    <div class="comment-form">
                        <img th:src="@{${session.userId != null ? userAvatar : '/img/default-avatar.png'}}" class="avatar-tiny">
                        <div class="comment-input-wrapper">
                            <textarea class="comment-input" placeholder="Ajouter un commentaire..." rows="1"></textarea>
                            <button class="btn-send-comment"><i data-lucide="send"></i></button>
                        </div>
                    </div>
                    <div class="comments-list"></div>
                </div>
            </article>
        </div>
    </main>

    <aside class="sidebar-right">
        <div class="announcement-part card">
            <div class="announcement-title">
                <h5><i data-lucide="megaphone" style="color:var(--primary)"></i> Annonces</h5>
            </div>
            <div class="announcement-item">
                <h6>Inscriptions S2</h6>
                <p>Date limite : Demain 23h59...</p>
            </div>
        </div>
    </aside>
</div>

<div id="editModal">
    <div class="modal-card card">
        <div class="modal-header">
            <h3>Modifier la publication</h3>
            <button id="closeEditModal" aria-label="Fermer">‚úï</button>
        </div>
        <div class="modal-body">
            <textarea id="editContent" rows="5"></textarea>
            <div class="modal-controls">
                <select id="editVisibility" class="custom-select">
                    <option value="PUBLIC">Public</option>
                    <option value="FRIENDS">Amis</option>
                    <option value="PRIVATE">Priv√©</option>
                </select>
                <label class="checkbox-label">
                    <input id="editAllowComments" type="checkbox"/>
                    <span>Commentaires</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button id="saveEditBtn" class="btn-primary">Enregistrer</button>
        </div>
    </div>
</div>

<script th:src="@{/js/header.js}"></script>
<script th:src="@{/js/feed-posts.js}"></script>
<script th:src="@{/js/reactions.js}"></script>
<script th:src="@{/js/comments.js}"></script>
<script>
    lucide.createIcons();

    // Moment.js Logic
    document.addEventListener("DOMContentLoaded", function() {
        moment.locale('fr');
        document.querySelectorAll('.post-date').forEach(function(el) {
            const rawDate = el.getAttribute('data-timestamp');
            if (rawDate) {
                const dateMoment = moment(rawDate);
                el.innerText = moment().diff(dateMoment, 'hours') < 24 ? dateMoment.fromNow() : dateMoment.format('D MMMM YYYY');
            }
        });
    });

    // Modal Logic
    const modal = document.getElementById('editModal');
    const closeBtn = document.getElementById('closeEditModal');
    if(closeBtn) closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

    function openEditModalFromButton(btn) {
        modal.style.display = "flex";
        // La logique de remplissage du contenu est g√©r√©e dans feed-posts.js
    }
</script>
</body>
</html>