<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fil d'actualité - ISEP Connect</title>
<link rel="stylesheet" th:href="@{/css/charteGraphique.css}">
<link rel="stylesheet" th:href="@{/css/header.css}">
<link rel="stylesheet" th:href="@{/css/accueil.css}">
<script src="https://unpkg.com/lucide@latest"></script>
<meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
<meta th:if="${_csrf != null}" name="_csrf_header"
	th:content="${_csrf.headerName}" />
</head>
<body>

	<div th:replace="~{fragments/header :: header-fragment}"></div>

	<div class="container container-narrow"
		style="display: grid; grid-template-columns: 260px 1fr 300px; gap: 20px; margin-top: 20px;">

		<!-- left sidebar (simple) -->
		<aside>
			<div class="card"
				style="padding: 16px; background: var(- -bg-card); border: 1px solid var(- -border); border-radius: 12px;">
				<h4 th:text="${name}">Utilisateur</h4>
				<p>Bienvenue sur votre fil</p>
			</div>
		</aside>

		<!-- main feed -->
		<main>
			<!-- publication form (only if connected) -->
			<div th:if="${session.userId != null}">
				<div class="publish-card" style="margin-bottom: 18px;">
					<div class="publish-inner"
						style="display: flex; gap: 12px; align-items: flex-start;">
						<div class="avatar-box">
							<img th:src="@{${userAvatar}}" alt="avatar"
								style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;" />
						</div>
						<form th:action="@{/post}" method="post" class="publish-form"
							style="flex: 1;" enctype="multipart/form-data">
							<input type="hidden" name="allowComments" value="false" />
							<textarea name="content" placeholder="Quoi de neuf ?" rows="2"></textarea>
							<div
								style="display: flex; gap: 12px; align-items: center; margin-top: 10px;">
								<div class="publish-icons" style="display: flex; gap: 8px;">
									<button type="button" id="postImage" class="icon-btn"
										style="background: transparent; border: none; color: var(- -text-dim);">
										<i data-lucide="image"></i>
									</button>
									<button type="button" id="postVideo" class="icon-btn"
										style="background: transparent; border: none; color: var(- -text-dim);">
										<i data-lucide="link"></i>
									</button>
								</div>

								<input type="file" id="postVideoUrl" name="postVideoUrl"
									accept=".mp4, .avi" style="display: none;"> <input
									type="file" id="postImageUrl" name="postImageUrl"
									accept="image/*" style="display: none;"> <select
									id="visibilityType" name="visibilityType"
									class="publish-visibility">
									<option value="PUBLIC">Public</option>
									<option value="FRIENDS">Amis</option>
									<option value="PRIVATE">Privé</option>
								</select> <label style="display: flex; align-items: center; gap: 6px;"><input
									type="checkbox" name="allowComments" value="true" checked />
									Autoriser les commentaires</label>
								<button type="submit" class="btn-primary">Publier</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- posts list -->
			<div>
				<div th:each="post : ${posts}" class="card"
					th:attr="data-post-card-id=${post.id}"
					style="margin-bottom: 12px; padding: 16px; background: var(- -bg-card); border: 1px solid var(- -border); border-radius: 12px;">
					<div style="display: flex; gap: 12px; align-items: flex-start;">
						<div style="width: 48px;">
							<img th:src="@{${post.author.profilePictureUrl}}" alt="avatar"
								style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;" />
						</div>
						<div style="flex: 1;">
							<div
								style="display: flex; justify-content: space-between; align-items: center;">
								<div>
									<strong th:text="${post.author.username}">Auteur</strong>
									<div style="font-size: 0.85rem; color: var(- -text-dim);"
										th:text="${post.createdAt}">date</div>
								</div>
								<div style="display: flex; gap: 8px; align-items: center;">
									<div style="font-size: 0.85rem; color: var(- -text-dim);"
										th:text="${post.visibilityType}">VIS</div>
									<button type="button" class="btn-icon"
										th:if="${loggedUserId != null and loggedUserId.toString() == post.author.id.toString()}"
										th:attr="data-post-id=${post.id}" title="Modifier"
										style="border: none; background: transparent; cursor: pointer;">
										<i data-lucide="edit-2"></i>
									</button>
									<button type="button" class="btn-icon btn-delete"
										th:if="${loggedUserId != null and loggedUserId.toString() == post.author.id.toString()}"
										th:attr="data-post-id=${post.id}" title="Supprimer"
										style="border: none; background: transparent; cursor: pointer; color: var(- -danger);">
										<i data-lucide="trash-2"></i>
									</button>
								</div>
							</div>
							<p style="margin-top: 8px;" th:text="${post.content}">Contenu
								du post</p>
							<div th:each="pm : ${post.medias}">
								<img th:if="${pm.mediaType.toString().equals('IMAGE')}"
									th:src="@{${pm.fileUrl}}" alt="Example" style="max-width: 100%; height: auto;">
									
								<video th:if="${pm.mediaType.toString().equals('VIDEO')}" style="max-width: 100%; height: auto;" controls>
									<source th:src="@{${pm.fileUrl}}" type="video/mp4">
								</video>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>

		<!-- right sidebar (simple) -->
		<aside>
			<div class="card"
				style="padding: 16px; background: var(- -bg-card); border: 1px solid var(- -border); border-radius: 12px;">
				<h4>Annonces</h4>
				<p>Événements récents et topics</p>
			</div>
		</aside>

	</div>

	<div th:replace="~{fragments/footer :: footer-fragment}"></div>
	<script th:src="@{/js/header.js}"></script>
	<script th:src="@{/js/feed-posts.js}"></script>
	<script>lucide.createIcons();</script>
	<!-- Edit modal -->
	<div id="editModal"
		style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); align-items: center; justify-content: center;">
		<div
			style="background: white; padding: 16px; width: 640px; max-width: 94%; border-radius: 8px;">
			<div
				style="display: flex; justify-content: space-between; align-items: center;">
				<h3>Modifier la publication</h3>
				<button id="closeEditModal" aria-label="Fermer"
					style="border: none; background: transparent; font-size: 1.2rem; cursor: pointer;">✕</button>
			</div>
			<div style="margin-top: 8px;">
				<textarea id="editContent" rows="4" style="width: 100%;"></textarea>
				<div
					style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
					<select id="editVisibility" style="padding: 4px;">
						<option value="PUBLIC">Public</option>
						<option value="FRIENDS">Amis</option>
						<option value="PRIVATE">Privé</option>
					</select> <label style="display: flex; align-items: center; gap: 6px;"><input
						id="editAllowComments" type="checkbox" /> Autoriser les
						commentaires</label>
				</div>
				<div
					style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px;">
					<button id="saveEditBtn" class="btn-primary">Enregistrer</button>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
